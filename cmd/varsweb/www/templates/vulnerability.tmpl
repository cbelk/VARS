//////////////////////////////////////////////////////////////////////////////////////
//                                                                                  //
//    VARS (Vulnerability Analysis Reference System) is software used to track      //
//    vulnerabilities from discovery through analysis to mitigation.                //
//    Copyright (C) 2017  Christian Belk                                            //
//                                                                                  //
//    This program is free software: you can redistribute it and/or modify          //
//    it under the terms of the GNU General Public License as published by          //
//    the Free Software Foundation, either version 3 of the License, or             //
//    (at your option) any later version.                                           //
//                                                                                  //
//    This program is distributed in the hope that it will be useful,               //
//    but WITHOUT ANY WARRANTY; without even the implied warranty of                //
//    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the                 //
//    GNU General Public License for more details.                                  //
//                                                                                  //
//    See the full License here: https://github.com/cbelk/vars/blob/master/LICENSE  //
//                                                                                  //
//////////////////////////////////////////////////////////////////////////////////////

{% raw %}

// Display vulnerabilities
{{define "vulns"}}
{{template "header"}}
{{template "navbar" .User}}
{{if .User.Authed}}
<nav class="navbar navbar-expanded-lg fixed-top fixed-top-2 navbar-dark navbar-vdark">
    <div class="container-fluid d-flex flex-row justify-content-between">
            <button type="button" class="btn-sm btn-success" id="add-vuln" data-toggle="modal" data-target="#vuln-modal" data-vid="-2" aria-label="Add">
                <span aria-hidden="true">&plus;</span>
            </button>
            <a class="nav-link text-white" href="#" onclick="loadVulnTable('open')">Open Vulnerabilities</a>
            <a class="nav-link text-white" href="#closed" onclick="loadVulnTable('closed')">Closed Vulnerabilities</a>
            <a class="nav-link text-white" href="#all" onclick="loadVulnTable('all')">All Vulnerabilities</a>
            <form class="form-inline"><input type="search" id="vuln-table-search" placeholder="Search by name or CVE" aria-label="Search"></form>
    </div>
</nav>
<div class="container-fluid pt-3 pb-3 pl-5 pr-5 vars-content">
    <div class="table-responsive">
    <table class="table table-striped table-dark table-bordered table-hover" id="vuln-table">
        <thead>
            <tr>
                <th scope="col" class="col-2" onclick="sortTable('vuln-table', 0)">Name</th>
                <th scope="col" class="col-3" onclick="sortTable('vuln-table', 1)">Summary</th>
                <th scope="col" class="col-1" onclick="sortTable('vuln-table', 2)">CVSS</th>
                <th scope="col" class="col-1" onclick="sortTable('vuln-table', 3)">Corporate Risk Score</th>
                <th scope="col" class="col-3" onclick="sortTable('vuln-table', 4)">CVE</th>
                <th scope="col" class="col-1" onclick="sortTable('vuln-table', 5)">Date Opened</th>
                <th scope="col" class="col-1" onclick="sortTable('vuln-table', 6)">Date Closed</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>
    </div>
</div>
{{template "vuln-modal" .User}}
{{end}}
{{template "footer" .Page}}
{{end}}

// Vulnerability Modal
{{define "vuln-modal"}}
<div class="modal fade" id="vuln-modal" tabindex="-1" role="dialog" aria-labelledby="vuln-modal-label" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header" id="vuln-modal-section-title">
                <h1 class="modal-title" id="vuln-modal-label">
                    <div class="row justify-content-start">
                    <div class="col-1">
                        {{if le .Emp.Level 1}}
                        <button type="button" class="btn-sm bg-white text-success border-0 vme-btn vme-btn-title vme-pen" id="vuln-modal-edit-title" onclick="showModalEdit(this.id)" aria-label="Edit">
                            <span aria-hidden="true">&#9998;</span>
                        </button>
                        {{else}}
                        <p> </p>
                        {{end}}
                    </div>
                    <div class="col-11">
                        <form class="form-inline" id="vuln-modal-form-title">
                            <input type="text" class="form-control-plaintext" readonly id="vuln-modal-title" name="name" value="">
                            <button type="submit" class="btn btn-dark vme-btn-submit vme-btn-title-submit">Submit</button>
                        </form>
                    </div>
                    </div>
                </h1>
                <div class="btn-group" role="group" aria-label="Modal top buttons">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            </div>
            <div class="modal-body">
            <div class="containier-fluid">
                <!-- VulnID -->
                <div class="row justify-content-start">
                    <div class="col">
                        <p id="vuln-modal-vulnid" hidden>-1</p>
                    </div>
                </div>
                <!-- VulnID end -->
                <!-- Alerts -->
                <div class="row justify-content-start alert alert-success" role="alert" id="vuln-modal-alert-success">
                Vulnerability Assessment successfully updated
                </div>
                <div class="row justify-content-start alert alert-danger" role="alert" id="vuln-modal-alert-danger">
                <p id="vuln-modal-alert-danger-item">There was an error processing your request</p>
                </div>
                <div class="row justify-content-start alert alert-warning" role="alert" id="vuln-modal-alert-warning">
                <p id="vuln-modal-alert-warning-item"></p> <button type="button" class="btn btn-success" id="vuln-modal-warning-yes" onclick="placeholder()">Yes</button><button type="button" class="btn btn-danger" id="vuln-modal-warning-no" onclick="placeholder()">No</button>
                </div>
                <!-- Alerts end -->
                <!-- Summary -->
                <div id="vuln-modal-section-summary">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <h3>Summary</h3>
                    </div>
                </div>
                <div class="row justify-content-start" id="vuln-modal-div-summary">
                    <div class="col-1">
                        <button type="button" class="btn-sm bg-white text-success border-0 vme-btn vme-btn-summary vme-pen" id="vuln-modal-edit-summary" onclick="showModalEdit(this.id)" aria-label="Edit">
                            <span aria-hidden="true">&#9998;</span>
                        </button>
                    </div>
                    <div class="col-11">
                        <form id="vuln-modal-form-summary" action="#" method="post">
                            <textarea id="vuln-modal-summary" name="summary" readonly class="form-control-plaintext" rows="4" cols="65">Summary goes here</textarea>
                            <button type="submit" class="btn btn-dark vme-btn-submit">Submit</button>
                        </form>
                    </div>
                </div>
                </div>
                <!-- Summary end -->
                <hr>
                <!-- Cve -->
                <div id="vuln-modal-section-cve">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <button type="button" class="btn-sm btn-success vme-btn vme-btn-cve" id="vuln-modal-add-cve" onclick="handleModalAddItem(this.id)" aria-label="Add">
                            <span aria-hidden="true">&plus;</span>
                        </button>
                    </div>
                    <div class="col-11">
                        <h3>CVEs</h3>
                    </div>
                </div>
                <div class="row justify-content-start" id="vuln-modal-div-add-cve">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <form id="vuln-modal-form-add-cve" action="#" method="post">
                            <input type="text" id="vuln-modal-add-cve-text" name="cve" value="">
                            <button type="submit" class="btn btn-dark">Submit</button>
                        </form>
                    </div>
                </div>
                <div id="vuln-modal-cve-list">
                </div>
                </div>
                <!-- Cve end -->
                <hr>
                <!-- Cvss -->
                <div id="vuln-modal-section-cvss">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <h3>Cvss</h3>
                    </div>
                </div>
                <div class="row justify-content-start" id="vuln-modal-div-cvss">
                    <div class="col-1">
                        <button type="button" class="btn-sm bg-white text-success border-0 vme-btn vme-btn-cvss vme-pen" id="vuln-modal-edit-cvss" onclick="showModalEdit(this.id)" aria-label="Edit">
                            <span aria-hidden="true">&#9998;</span>
                        </button>
                    </div>
                    <div class="col-11">
                        <a id="vuln-modal-cvss" href="#">CVSS</a>
                    </div>
                </div>
                <div class="row justify-content-start" id="vuln-modal-div-edit-cvss">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <form id="vuln-modal-form-cvss" action="#" method="post">
                            <input type="number" step="0.1" id="vuln-modal-cvss-edit" name="cvssScore" value="">
                            <input type="url" id="vuln-modal-cvss-link-edit" name="cvssLink" value="">
                            <button type="submit" class="btn btn-dark vme-btn-submit">Submit</button>
                        </form>
                    </div>
                </div>
                </div>
                <!-- Cvss end -->
                <hr>
                <!-- Corpscore -->
                <div id="vuln-modal-section-corpscore">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <h3>Corporate Risk Score</h3>
                    </div>
                </div>
                <div class="row justify-content-start" id="vuln-modal-div-corpscore">
                    <div class="col-1">
                        <button type="button" class="btn-sm bg-white text-success border-0 vme-btn vme-btn-corpscore vme-pen" id="vuln-modal-edit-corpscore" onclick="showModalEdit(this.id)" aria-label="Edit">
                            <span aria-hidden="true">&#9998;</span>
                        </button>
                    </div>
                    <div class="col-11">
                        <form id="vuln-modal-form-corpscore" action="#" method="post">
                            <input type="number" step="0.1" id="vuln-modal-corpscore" class="form-control-plaintext" readonly name="corpscore" value="">
                            <button type="submit" class="btn btn-dark vme-btn-submit">Submit</button>
                        </form>
                    </div>
                </div>
                </div>
                <!-- Corpscore end -->
                <hr>
                <!-- Test -->
                <div id="vuln-modal-section-test">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <h3>Test to see if system is affected</h3>
                    </div>
                </div>
                <div class="row justify-content-start">
                    <div class="col-1">
                        <button type="button" class="btn-sm bg-white text-success border-0 vme-btn vme-btn-test vme-pen" id="vuln-modal-edit-test" onclick="showModalEdit(this.id)" aria-label="Edit">
                            <span aria-hidden="true">&#9998;</span>
                        </button>
                    </div>
                    <div class="col-11">
                        <form id="vuln-modal-form-test" action="#" method="post">
                            <textarea id="vuln-modal-test" name="test" readonly class="form-control-plaintext" rows="4" cols="65">Test goes here</textarea>
                            <button type="submit" class="btn btn-dark vme-btn-submit">Submit</button>
                        </form>
                    </div>
                </div>
                </div>
                <!-- Test end -->
                <hr>
                <!-- Mitigation -->
                <div id="vuln-modal-section-mitigation">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <h3>Mitigation steps</h3>
                    </div>
                </div>
                <div class="row justify-content-start">
                    <div class="col-1">
                        <button type="button" class="btn-sm bg-white text-success border-0 vme-btn vme-btn-mitigation vme-pen" id="vuln-modal-edit-mitigation" onclick="showModalEdit(this.id)" aria-label="Edit">
                            <span aria-hidden="true">&#9998;</span>
                        </button>
                    </div>
                    <div class="col-11">
                        <form id="vuln-modal-form-mitigation" action="#" method="post">
                            <textarea id="vuln-modal-mitigation" name="mitigation" readonly class="form-control-plaintext" rows="4" cols="65">Mitigation strategy goes here</textarea>
                            <button type="submit" class="btn btn-dark vme-btn-submit">Submit</button>
                        </form>
                    </div>
                </div>
                </div>
                <!-- Mitigation end -->
                <hr>
                <!-- Finder -->
                <div id="vuln-modal-section-finder">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <h3>Found by</h3>
                    </div>
                </div>
                <div class="row justify-content-start">
                    <div class="col-1">
                        <button type="button" class="btn-sm bg-white text-success border-0 vme-btn vme-btn-finder vme-pen" id="vuln-modal-edit-finder" onclick="showModalEdit(this.id)" aria-label="Edit">
                            <span aria-hidden="true">&#9998;</span>
                        </button>
                    </div>
                    <div class="col-11">
                        <form id="vuln-modal-form-finder" action="#" method="post">
                            <select class="custom-select" name="finder" id="vuln-modal-finder" {{if le .Emp.Level 1}}data-editable{{end}}>
                            </select>
                            <button type="submit" class="btn btn-dark vme-btn-submit">Submit</button>
                        </form>
                    </div>
                </div>
                </div>
                <!-- Finder end -->
                <hr>
                <!-- Initiator -->
                <div id="vuln-modal-section-initiator">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <h3>Initiated by</h3>
                    </div>
                </div>
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <p id="vuln-modal-initiator"></p>
                    </div>
                </div>
                </div>
                <!-- Initiator end -->
                <hr>
                <!-- Date Opened -->
                <div id="vuln-modal-section-date-opened">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <h3>Date VA opened</h3>
                    </div>
                </div>
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <p id="vuln-modal-initiated">Date initiated goes here</p>
                    </div>
                </div>
                </div>
                <!-- Date Opened end -->
                <hr>
                <!-- Date Closed -->
                <div id="vuln-modal-section-date-closed">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <h3 id="vuln-modal-mitigated-header">Date VA closed</h3>
                    </div>
                </div>
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <p id="vuln-modal-mitigated">Date mitigated goes here</p>
                    </div>
                </div>
                </div>
                <!-- Date Closed end -->
                <hr>
                <!-- Tickets -->
                <div id="vuln-modal-section-tickets">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <button type="button" class="btn-sm btn-success vme-btn vme-btn-ticket" id="vuln-modal-add-ticket" onclick="handleModalAddItem(this.id)" aria-label="Add">
                            <span aria-hidden="true">&plus;</span>
                        </button>
                    </div>
                    <div class="col-11">
                        <h3>Tickets</h3>
                    </div>
                </div>
                <div class="row justify-content-start" id="vuln-modal-div-add-ticket">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <form id="vuln-modal-form-add-ticket" action="#" method="post">
                            <input type="text" id="vuln-modal-add-ticket-text" name="ticket" value="">
                            <button type="submit" class="btn btn-dark">Submit</button>
                        </form>
                    </div>
                </div>
                <div id="vuln-modal-ticket-list">
                </div>
                </div>
                <!-- Tickets end -->
                <hr>
                <!-- References -->
                <div id="vuln-modal-section-refs">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <button type="button" class="btn-sm btn-success vme-btn vme-btn-ref" id="vuln-modal-add-ref" onclick="handleModalAddItem(this.id)" aria-label="Add">
                            <span aria-hidden="true">&plus;</span>
                        </button>
                    </div>
                    <div class="col-11">
                        <h3>References</h3>
                    </div>
                </div>
                <div class="row justify-content-start" id="vuln-modal-div-add-ref">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <form id="vuln-modal-form-add-ref" action="#" method="post">
                            <input type="url" id="vuln-modal-add-ref-text" name="ref" value="">
                            <button type="submit" class="btn btn-dark">Submit</button>
                        </form>
                    </div>
                </div>
                <div id="vuln-modal-ref-list">
                </div>
                </div>
                <!-- References end -->
                <hr>
                <!-- Exploitable -->
                <div id="vuln-modal-section-exploitable">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <h3 id="vuln-modal-exploitable-header">Exploitable</h3>
                    </div>
                </div>
                <div class="row justify-content-start">
                    <div class="col-1">
                        <button type="button" class="btn-sm bg-white text-success border-0 vme-btn vme-btn-exploitable vme-pen" id="vuln-modal-edit-exploitable" onclick="showModalEdit(this.id)" aria-label="Edit">
                            <span aria-hidden="true">&#9998;</span>
                        </button>
                    </div>
                    <div class="col-11">
                        <form class="form-inline" id="vuln-modal-form-exploitable">
                            <select class="custom-select mb-2 mr-sm-2 mb-sm-0" id="vuln-modal-exploitable" name="exploitable">
                                <option value="true">True</option>
                                <option value="false">False</option>
                            </select>
                            <button type="submit" class="btn btn-dark vme-btn-submit">Submit</button>
                        </form>
                    </div>
                </div>
                </div>
                <!-- Exploitable end -->
                <hr>
                <!-- Exploit -->
                <div id="vuln-modal-section-exploit">
                <div class="row justify-content-start">
                    <div class="col-1">
                        <p></p>
                    </div>
                    <div class="col-11">
                        <h3 id="vuln-modal-exploit-header">Exploit Code</h3>
                    </div>
                </div>
                <div class="row justify-content-start">
                    <div class="col-1">
                        <button type="button" class="btn-sm bg-white text-success border-0 vme-btn vme-btn-exploit vme-pen" id="vuln-modal-edit-exploit" onclick="showModalEdit(this.id)" aria-label="Edit">
                            <span aria-hidden="true">&#9998;</span>
                        </button>
                    </div>
                    <div class="col-11">
                        <form id="vuln-modal-form-exploit" action="#" method="post">
                            <textarea id="vuln-modal-exploit" name="exploit" readonly class="form-control-plaintext" rows="4" cols="65">Exploit code goes here</textarea>
                            <button type="submit" class="btn btn-dark vme-btn-submit">Submit</button>
                        </form>
                    </div>
                </div>
                </div>
                <!-- Exploit end -->
                <hr>
                <!-- Affected -->
                <div id="vuln-modal-affected" roles="tablist">
                    <div class="card">
                        <div class="card-header" role="tab" id="vuln-modal-affected-header">
                            <h5 class="mb-0">
                                <a data-toggle="collapse" href="#vuln-modal-affected-collapse" aria-expanded="false" aria-controls="vuln-modal-affected-collapse" class="text-dark">
                                    View affected systems
                                </a>
                            </h5>
                        </div>
                        <div id="vuln-modal-affected-collapse" class="collapse" role="tabpanel" aria-labelledby="vuln-modal-affected-header" data-parent="#vuln-modal-affected">
                            <div class="card-body">
                                <div id="vuln-modal-div-add-affected">
                                    <form class="form-inline" id="vuln-modal-form-add-affected">
                                        <label class="mr-sm-2" for="#vme-add-affected-list">Mark as affected: </label>
                                        <select class="custom-select" id="vme-add-affected-list" name="system">
                                        </select>
                                        <button type="submit" class="btn btn-dark">Submit</button>
                                    </form>
                                </div>
                                <div class="alert alert-dark" role="alert">
                                    Click to filter: 
                                    <a href="#" class="alert-link" onclick="handleShowAffected('open')">[un-patched] </a>
                                    <a href="#" class="alert-link" onclick="handleShowAffected('closed')">[patched] </a>
                                    <a href="#" class="alert-link" onclick="handleShowAffected('all')">[all] </a>
                                </div>
                                <div class="table-responsive">
                                <table class="table table-bordered table-hover" id="vuln-table-affected">
                                    <thead>
                                        <tr>
                                            <th scope="col">
                                                <button type="button" class="btn-sm btn-success" id="vuln-modal-add-affected" onclick="handleModalAddItem(this.id)" aria-label="Add">
                                                    <span aria-hidden="true">&plus;</span>
                                                </button>
                                            </th>
                                            <th scope="col" onclick="sortTable('vuln-table-affected', 1)">System Name</th>
                                            <th scope="col" onclick="sortTable('vuln-table-affected', 2)">Description</th>
                                            <th scope="col" onclick="sortTable('vuln-table-affected', 3)">Location</th>
                                            <th scope="col" onclick="sortTable('vuln-table-affected', 4)">State</th>
                                            <th scope="col">Patched</th>
                                        </tr>
                                    </thead>
                                    <tbody id="vuln-modal-affected-table">
                                    </tbody>
                                </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Affected end -->
                <!-- Notes -->
                <div id="vuln-modal-notes" roles="tablist">
                    <div class="card">
                        <div class="card-header" role="tab" id="vuln-modal-notes-header">
                            <h5 class="mb-0">
                                <a data-toggle="collapse" href="#vuln-modal-notes-collapse" aria-expanded="false" aria-controls="vuln-modal-notes-collapse" class="text-dark">
                                    View notes
                                </a>
                            </h5>
                        </div>
                        <div id="vuln-modal-notes-collapse" class="collapse" role="tabpanel" aria-labelledby="vuln-modal-notes-header" data-parent="#vuln-modal-notes">
                            <div class="card-body">
                                <div id="vuln-modal-div-add-note">
                                    <form class="form-inline" id="vuln-modal-form-add-note">
                                        <textarea id="vuln-modal-add-note" name="note" class="form-control" rows="4" cols="65"></textarea>
                                        <button type="submit" class="btn btn-dark">Submit</button>
                                    </form>
                                </div>
                                <div id="vuln-modal-notes-list">
                                </div>
                                <button type="button" class="btn-sm btn-success" id="vuln-modal-add-note" onclick="handleModalAddItem(this.id)" aria-label="Add">
                                    <span aria-hidden="true">&plus;</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Notes end -->
            </div>
            </div>
            <div class="modal-footer">
                {{if le .Emp.Level 1}}
                <button type="submit" class="btn btn-dark btn-lg btn-block vme-btn-submit" id="modal-add-vuln-btn">Submit</button>
                <button type="button" class="btn btn-danger btn-lg btn-block" id="modal-close-vuln-btn" onclick="showModalPrompt(this.id)">Close Vulnerability Analysis</button>
                <button type="button" class="btn btn-danger btn-lg btn-block" id="modal-reopen-vuln-btn" onclick="showModalPrompt(this.id)">Re-open Vulnerability Analysis</button>
                <button type="button" class="btn btn-dark btn-lg btn-block" id="modal-delete-vuln-btn" onclick="showModalPrompt(this.id)">Delete Vulnerability Analysis</button>
                {{end}}
            </div>
        </div>
    </div>
</div>
{{end}}

// Display vulnerability
{{define "vuln-page"}}
{{template "header"}}
{{template "navbar" .U}}
{{if .U.Authed}}
<div class="container">
    <h1 class="text-center">{{.Vuln.Name}}</h1>
</div>
{{end}}
{{template "footer"}}
{{end}}

{% endraw %}
